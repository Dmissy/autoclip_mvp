# 🎬 自动切片工具 - 项目总结

## 📋 项目概述

本项目实现了一个端到端视频切片推荐系统，通过多轮大模型推理实现智能视频内容分析与切片生成。系统能够从完整视频中自动提取精彩片段，生成爆点标题，并聚合为主题合集。

## 🏗️ 系统架构

### 核心设计理念
- **模块化设计**: 每个处理步骤独立封装，便于调试和维护
- **流水线处理**: 6个步骤依次执行，每步输出作为下步输入
- **容错机制**: 每步都有错误处理和重试机制
- **缓存机制**: 中间结果保存为JSON，支持断点续传

### 技术栈
- **大模型**: 通义千问API (qwen-max)
- **视频处理**: FFmpeg
- **Web界面**: Streamlit
- **数据处理**: Python + JSON
- **文本处理**: pysrt, 自定义文本分块算法

## 📁 项目结构

```
auto_clips_demo/
├── input/                 # 输入文件
│   ├── input.mp4         # 完整视频
│   ├── input.srt         # 字幕文件
│   └── input.txt         # 转写文本
├── prompt/               # 大模型提示词
│   ├── 大纲.txt
│   ├── 时间点.txt
│   ├── 推荐理由.txt
│   ├── 标题生成.txt
│   └── 主题聚类.txt
├── src/                  # 核心代码
│   ├── config.py        # 配置管理
│   ├── main.py          # 主程序
│   ├── pipeline/        # 处理流水线
│   │   ├── step1_outline.py
│   │   ├── step2_timeline.py
│   │   ├── step3_scoring.py
│   │   ├── step4_title.py
│   │   ├── step5_clustering.py
│   │   └── step6_video.py
│   └── utils/           # 工具函数
│       ├── llm_client.py
│       ├── text_processor.py
│       └── video_processor.py
├── output/              # 输出结果
│   ├── clips/           # 切片视频
│   ├── collections/     # 合集视频
│   └── metadata/        # 元数据
├── app.py              # Streamlit界面
├── run.py              # 命令行接口
├── test_system.py      # 系统测试
└── requirements.txt    # 依赖包
```

## 🔄 处理流程

### Step 1: 大纲提取
- **输入**: 完整转写文本
- **处理**: 按5000字符分块，逐块调用大模型提取结构性大纲
- **输出**: 话题大纲列表，包含一级话题和子话题
- **关键特性**: 文本分块保持语义完整，合并去重避免重复话题

### Step 2: 时间点提取
- **输入**: 大纲结构 + SRT字幕数据
- **处理**: 调用大模型定位每个话题的时间区间
- **输出**: 带时间戳的话题列表
- **关键特性**: 精确时间定位，处理静音段和混杂内容

### Step 3: 内容评分
- **输入**: 时间区间 + 完整文本 + SRT数据
- **处理**: 提取片段文本，多维度评分（语义完整、语言密度、金句潜力、情绪张力）
- **输出**: 评分结果和高分片段筛选
- **关键特性**: 四维评分体系，支持自定义阈值筛选

### Step 4: 标题生成
- **输入**: 高分片段 + 完整文本 + SRT数据
- **处理**: 为每个片段生成爆点标题
- **输出**: 带标题的片段列表
- **关键特性**: 基于金句提取，避免标题党，保持原意

### Step 5: 主题聚类
- **输入**: 带标题的片段列表
- **处理**: 基于标题和摘要进行主题聚类
- **输出**: 合集列表，每个合集包含标题、简介、片段列表
- **关键特性**: 智能聚类算法，支持默认聚类兜底

### Step 6: 视频切割
- **输入**: 带标题的片段 + 合集数据 + 原始视频
- **处理**: 使用FFmpeg生成切片视频和合集视频
- **输出**: 切片视频文件 + 合集视频文件 + 元数据
- **关键特性**: 批量处理，支持concat拼接

## 🛠️ 核心组件

### 1. LLM客户端 (llm_client.py)
- 封装通义千问API调用
- 支持重试机制和错误处理
- JSON响应解析和验证

### 2. 文本处理器 (text_processor.py)
- 智能文本分块算法
- SRT字幕解析
- 时间格式转换
- 基于时间范围的文本提取

### 3. 视频处理器 (video_processor.py)
- FFmpeg命令封装
- 视频切片和拼接
- 批量处理支持
- 视频信息获取

### 4. 配置管理 (config.py)
- 统一配置管理
- 路径配置
- API密钥管理
- 处理参数配置

## 🎯 关键特性

### 1. 智能文本分块
```python
def chunk_text(text: str, chunk_size: int = 5000) -> List[str]:
    # 按段落分割，保持语义完整
    # 处理超长段落，按句子分割
    # 避免机械分割自然表达单元
```

### 2. 多维度评分体系
- **语义完整 & 逻辑清晰** (30%)
- **语言密度 & 节奏紧凑** (20%)
- **金句传播力 & 引用潜力** (30%)
- **情绪张力 & 立场鲜明** (20%)

### 3. 容错机制
- 每步都有异常处理
- API调用支持重试
- 默认算法兜底
- 中间结果缓存

### 4. 灵活配置
- 支持单步运行
- 支持完整流水线
- 可配置评分阈值
- 可调整分块大小

## 🚀 使用方法

### 1. 环境准备
```bash
# 安装依赖
pip install -r requirements.txt

# 安装FFmpeg
# macOS: brew install ffmpeg
# Ubuntu: sudo apt install ffmpeg
```

### 2. Web界面使用 (推荐)
```bash
# 启动Streamlit界面
streamlit run app.py
```
启动后，在Web界面侧边栏输入你的API密钥，即可开始处理。

### 3. 命令行使用
如果你希望在命令行下运行，请先设置环境变量：
```bash
# 设置API密钥
export DASHSCOPE_API_KEY="your_api_key_here"

# 运行完整流水线
python run.py --full

# 运行单个步骤
python run.py --step 1

# 查看处理状态
python run.py --status

# 运行系统测试
python run.py --test
```

## 📊 输出结果

### 文件结构
```
output/
├── clips/                    # 切片视频
│   ├── clip_1.mp4
│   ├── clip_2.mp4
│   └── ...
├── collections/              # 合集视频
│   ├── collection_1.mp4
│   ├── collection_2.mp4
│   └── ...
└── metadata/                 # 元数据
    ├── step1_outline.json
    ├── step2_timeline.json
    ├── step3_scoring.json
    ├── step4_titles.json
    ├── step5_collections.json
    ├── clips_metadata.json
    └── processing_summary.json
```

### 元数据格式
```json
{
  "id": "1",
  "outline": "话题标题",
  "start_time": "00:01:25",
  "end_time": "00:02:53",
  "generated_title": "爆点标题",
  "final_score": 0.85,
  "recommend_reason": "推荐理由"
}
```

## 🔧 扩展性设计

### 1. 模块化架构
- 每个步骤独立封装
- 标准化的输入输出接口
- 易于添加新的处理步骤

### 2. 配置驱动
- 提示词文件化
- 参数可配置
- 支持不同模型切换

### 3. 插件化设计
- 支持自定义评分算法
- 支持自定义聚类算法
- 支持自定义视频处理

## 🎉 项目亮点

1. **端到端自动化**: 从原始视频到最终切片，全流程自动化
2. **智能内容理解**: 基于大模型的内容分析和理解
3. **多维度评估**: 科学的评分体系，确保内容质量
4. **用户友好**: 提供命令行和Web两种使用方式
5. **高度可配置**: 支持各种参数调整和自定义
6. **容错性强**: 完善的错误处理和重试机制
7. **扩展性好**: 模块化设计，易于功能扩展

## 🔮 未来改进方向

1. **多模型支持**: 支持更多大模型API
2. **实时处理**: 支持流式视频处理
3. **批量处理**: 支持多个视频批量处理
4. **云端部署**: 支持Docker容器化部署
5. **性能优化**: 并行处理和GPU加速
6. **更多格式**: 支持更多视频和字幕格式
7. **智能推荐**: 基于用户偏好的个性化推荐

## 📝 总结

本项目成功实现了一个功能完整、架构清晰的自动切片工具。通过模块化设计和流水线处理，系统能够高效地从视频中提取精彩内容，生成高质量的切片和合集。项目具有良好的扩展性和可维护性，为后续功能扩展奠定了坚实基础。 